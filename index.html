<!DOCTYPE html>
<html lang="en">
   <head runat="server">
      <asp:ContentPlaceHolder ID="htmlHead" runat="server" />
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      <meta http-equiv="refresh" content="600" />
      <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
      <meta http-equiv="Pragma" content="no-cache" />
      <meta http-equiv="Expires" content="0" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width = device-width, initial-scale = 1">
      <title>NorEMSO Gliders</title>
      <link rel="stylesheet" href="https://esri.github.io/calcite-maps/dist/css/calcite-bootstrap.min-v0.2.css">
      <link rel="stylesheet" href="https://esri.github.io/calcite-maps/dist/css/calcite-maps-arcgis-4.x.min-v0.2.css">
      <link rel="stylesheet" href="https://js.arcgis.com/4.3/esri/css/main.css">
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
      <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
      <style>
         .btn-group{
         margin-bottom: 20px;
         }

         #map {
         width: 100%;
         height: 350px;
         margin-top: 50px;
         }

         #mapViewDiv {
         width: 100%;
         height: 350px;
         margin: 0;
         padding-bottom: 0;
         position: relative;
         }
         h1, h2 {
         margin-top: 30px;
         margin-bottom: 15px;
         }
         p {
         margin-top: 20px;
         margin-left: 20px;  
         color: #8891a0;
         font-size: 90%;
         }
         #meta {
         margin-top: 20px;
         margin-bottom: 20px;
         }
         .container img{
         display: block;
         padding-top: 20px;
         padding-bottom: 20px;
         margin: 0 auto;
         }
      </style>
   </head>
   <body class="calcite-nav-top">
      <nav class="navbar calcite-navbar navbar-fixed-top calcite-text-light calcite-bg-dark">
         <div class="calcite-title calcite-overflow-hidden">
            <a target="" href="index.html">
            <img src="static/images/uib.png" style="cursor: default; height: 45px; margin-top: 0px; margin-right: 0px; margin-left: 4px;">
            </a>
            <span class="calcite-title-divider"></span>
            <span class="calcite-title-main">NorEMSO Ocean Gliders</span>
         </div>
      </nav>

      <div id='map'></div>

      <div class="container">

         <div class="row">
            <div class="page-header-title col-lg-6 col-md-6 col-sm-12">
               <h2 class="text-left">Deployment Data</h2>
            </div>
         </div>
         <div id="plotly"></div>
         <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12">
               
               <div class="btn-group">
                  <button class="btn btn-default dropdown-toggle gliderBtn" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true"> <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu dropdownSelectGliders" aria-labelledby="dropdownMenu1"></ul>
               </div>



               <div class="btn-group">
                  <button class="btn btn-primary" id="displayBtn" type="button" aria-haspopup="true" aria-expanded="true">Display
                  </button>
               </div>

            </div>
         </div>
         <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12">
               <ul class="nav nav-tabs" role="tablist">
                  <li role="presentation" class="active"><a href="#science" aria-controls="science" role="tab" data-toggle="tab">Science</a></li>
                  <li role="presentation"><a href="#flight" aria-controls="flight" role="tab" data-toggle="tab">Flight</a></li>
                  <li role="presentation"><a href="#surface" aria-controls="surface" role="tab" data-toggle="tab">Surface Data</a></li>
               </ul>
               <div class="tab-content">
                  <div role="tabpanel" class="tab-pane fade in active" id="science"></div>
                  <div role="tabpanel" class="tab-pane fade" id="flight"></div>
                  <div role="tabpanel" class="tab-pane fade" id="surface"></div>                  
               </div>
            </div>
         </div>
      </div>
      <div class="panel-footer panel-primary img-rounded">
         <p class="text-muted text-right"><br>NorGliders Real-time Glider Data Portal</p>
      </div>
      </div>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
      <script src="https://js.arcgis.com/4.5/"></script>
      <script src="js/calcitemaps-v0.4.js"></script>
      
      <script>
      // SCRIPT FOR GLIDER.HTML
      var science_plots = [ 'EntireMission-profile_sci_water_temp',
                        'EntireMission-profile_salinity',
                        'EntireMission-profile_potential_density',
                        'EntireMission-3D_sci_water_temp',
                        'EntireMission-3D_salinity',
                        'EntireMission-3D_potential_density',
                        'EntireMission-time_scatter_sci_water_temp',
                        'EntireMission-time_scatter_salinity',
                        'EntireMission-time_scatter_potential_density',
                        'LastSegment-CTD_profile',
                        'LastSegment-CTD_scatter',
                        'LastSegment-density_scatter']

      var flight_plots = [ 'EntireMission-m_depth',
                     'EntireMission-m_battpos',
                     'EntireMission-m_battpos_Vs_m_pitch', 
                     'EntireMission-m_heading',             
                     'EntireMission-m_pitch',               
                     'LastSegment-m_battpos',
                     'LastSegment-m_de_oil_vol',            
                     'LastSegment-m_depth',
                     'LastSegment-m_heading',
                     'LastSegment-m_pitch',
                     'LastSegment-depth_rate',              
                     'LastSegment-water_speed']

      var surface_plots = [ 'Battery_diagnostics_current',  
                     'Battery_diagnostics_voltage',   
                     'm_battery',                    
                     'm_bms_aft_current',            
                     'm_bms_ebay_current',           
                     'm_bms_pitch_current',          
                     'm_coulomb_amphr',
                     'm_coulomb_amphr_total',
                     'm_lithium_battery_relative_charge', 
                     'm_vacuum',          
                     'c_autoballast_state',          
                     'c_autoballast_volume',         
                     'c_climb_bpump',                
                     'c_dive_bpump',  
                     'm_avg_climb_rate',  
                     'm_avg_dive_rate', 
                     'm_avg_upward_inflection_time', 
                     'srf_dac',  
                     'm_water_vx',  
                     'm_water_vy',           
                     'm_iridium_signal_strength',                
                     'c_iridium_current_num', 
                     'm_iridium_attempt_num',                        
                     'c_wpt_lat',                    
                     'c_wpt_lon',
                     'u_alt_min_depth',
                     'm_tot_num_inflections',
                     'm_digifin_leakdetect_reading',
                     'm_leakdetect_voltage',
                     'm_leakdetect_voltage_forward',
                     'm_leakdetect_voltage_science']

      // --- Read JSON ---
      $.getJSON("static/active_gliders_surface.json", function(obj) {  

         var gliderNames = Object.keys(obj.gliders);
         var gliderObj = obj.gliders;  
         var firstProject = gliderObj[gliderNames[0]].Project.toLowerCase()
         var positions = gliderObj[gliderNames[0]].TS.Position[0];
         var segmentsTime = gliderObj[gliderNames[0]].TS.Time[0];
         var segmentsName = gliderObj[gliderNames[0]].TS.SegmentName[0];
         var lengthLat = positions.length-1;
         var tracksIcon = L.icon({
             iconUrl: 'static/images/full-moon.png',
             iconSize:     [8, 8], // size of the icon
         });
         var gliderIcon = L.icon({
             iconUrl: 'static/images/slocum_glider.png',
             iconSize:     [40, 40], // size of the icon
         });
         var surfacings = L.layerGroup();
         var waypoints = L.layerGroup();
         var tracks = L.layerGroup();
         var gliderLatest = L.layerGroup();
         var initLat, initLon = [];

         // Load all glider tracks on load
         for (var g in gliderObj) {
            var thisProjectObj = gliderObj[g];
            var positions = thisProjectObj.TS.Position[0];
            var segmentsTime = thisProjectObj.TS.Time[0];
            var segmentsName = thisProjectObj.TS.SegmentName[0];
            var lengthLat = positions.length-1;

            // Surfacings
            for (var i=0; i < positions.length; i++){
               var customPopup = 'Segment: ' + segmentsName[i] + '<br/>Time: ' + segmentsTime[i];
               L.marker([positions[i][0],positions[i][1]], {icon: tracksIcon}).bindPopup(customPopup).addTo(surfacings);
            }

            // Tracks
            L.polyline(positions, {color: 'red'}).addTo(tracks);  

            // Latest Surfacing
            L.marker([positions[lengthLat][0], positions[lengthLat][1]], {icon: gliderIcon}).bindPopup(segmentsTime[lengthLat]).addTo(gliderLatest);

            // Waypoints
            //L.marker([63.8,  4.0]).bindPopup('Waypoint 1').addTo(waypoints),

            // Initial map position
            if (initLat == null) {
               initLat = positions[lengthLat][0];
               initLon = positions[lengthLat][1];
            }
         } 

         // SST layer
        // var proxy = 'server/proxy.php';


         var mbUrl = 'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw',
             mbAttr = '<a href="https://www.uib.no/gfi">Geofysisk institutt - Universitetet i Bergen</a>';

         var gray = L.tileLayer(mbUrl, {id: 'mapbox/light-v9', tileSize: 512, zoomOffset: -1, attribution: mbAttr}),
             dark  = L.tileLayer(mbUrl, {id: 'mapbox/dark-v10', tileSize: 512, zoomOffset: -1, attribution: mbAttr}),
             oceans = L.tileLayer('http://services.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/{z}/{y}/{x}.png', {attribution: mbAttr});
            // wmsLayer = L.tileLayer.wms('http://metmaps.met.no/metmaps/default.map?', {layers: 'ice.ice_chart'});           

         var map = L.map('map', {
            center: [initLat, initLon],
            zoom: 6,
            layers: [oceans, surfacings, tracks, gliderLatest] // waypoints,
         });

         var baseLayers = {
            "Oceans": oceans,     
            "Grayscale": gray,
            "Dark": dark  
         };

         var overlays = {
            "Glider Surfacings": surfacings,
            "Glider Track": tracks,
            "Glider Latest": gliderLatest
            //"SST": wmsLayer 
          //  "Current Waypoint": waypoints
         };

         L.control.layers(baseLayers, overlays).addTo(map);

         // Loop through active gliders
         for (var g in gliderNames) {
            var thisProjectName = gliderNames[g] // STR glider name
            var thisProjectObj = gliderObj[thisProjectName]; // OBJ surface structure gliderObj[gliderNames[0]];

            // Make first glider default
            if(g==0){
               var gliderDropdownStr = ('<li><a>' + thisProjectObj.Project + '</a></li>'); //+  thisProjectObj.skuld + ' 
               $('.gliderBtn').html(thisProjectObj.Project + ' <span class="caret"></span>');
               $('.dropdownSelectGliders').append(gliderDropdownStr);
               $('.dropdownSelectGliders li').last().addClass("selectGlider1")
               $('.dropdownSelectGliders li').last().addClass("selected1")
               $('.dropdownSelectGliders li').last().addClass("preselected1")
                  }
            else {
               var gliderDropdownStr = ('<li><a>' + thisProjectObj.Project + '</a></li>');
               $('.dropdownSelectGliders').append(gliderDropdownStr);
               $('.dropdownSelectGliders li').last().addClass("selectGlider1")
                  }  
               }


         // Display plots of first project on load
         // Science
         var $list = $('<div />');
         $list.addClass('plot_data'); 
         $(science_plots ).each(function(i, myvar) { 
         var png_src = ('static/' + firstProject + '/science/' + myvar + '.png');
         $list.append( $('<img class="img-responsive center-block" />').attr('src', png_src ) );
         });
         $('#science').append( $list );

         // Flight
         var $list = $('<div />');
         $list.addClass('plot_data'); 
         $(flight_plots ).each(function(i, myvar) { 
         var png_src = ('static/' + firstProject + '/flight/' + myvar + '.png');
         $list.append( $('<img class="img-responsive center-block" />').attr('src', png_src ) );
         });
         $('#flight').append( $list );

         // Surface
         var $list = $('<div />');
         $list.addClass('plot_data'); 
         $(surface_plots ).each(function(i, myvar) { 
         var png_src = ('static/' + firstProject + '/surface/' + myvar + '.png');
         $list.append( $('<img class="img-responsive center-block" />').attr('src', png_src ) );
         });
         $('#surface').append( $list );

      // --- Clear current time period by deleting class "selected" then apply this to new selection ---
      $(".selectGlider").click(function(){
            var selText = $(this).text();
            $('.preselected').removeClass('preselected'); 
            $(this).addClass("preselected");
            $(this).parents('.btn-group').find('.dropdown-toggle').html(selText+' <span class="caret"></span>');
      });

      // --- Clear current glider by deleting class "selected1" then apply this to new selection ---
      $('body').on('click', '.selectGlider1', function () {
         var selText = $(this).text();
         $('.preselected1').removeClass('preselected1'); 
         $(this).addClass("preselected1")
         $(this).parents('.btn-group').find('.dropdown-toggle').html(selText+' <span class="caret"></span>');
      });

      // --- Display button function ---
      $("#displayBtn").click(function(){
         // Get newly selected time period
         var thisTime = $('.timeBtn').text().replace(/\s+/g, '');
         // Get newly selected  glider
         var thisProject = $('.gliderBtn').text().trim();
         // Old time 
         var oldTime = $('.selected').text().replace(/\s+/g, '');
         // Old glider
         var oldProject = $('.selected1').text().trim();

         // Only proceed if these these both aren't the current settings
         if (thisProject != oldProject) {

            // Pan to area
            // This glider latest poistion
         for (var g in gliderNames) {
            var thisGliderName = gliderNames[g] // STR glider name
            var thisProjectObj = gliderObj[thisGliderName]; // OBJ surface structure gliderObj[gliderNames[0]];
               if (thisProject == thisProjectObj.Project){
                  map.flyTo(new L.LatLng(thisProjectObj.TS.Position[0][0][0], thisProjectObj.TS.Position[0][0][1]),6)
               }
            }
            
            // Remove selected classes and apply to new selections
            $('.selected').removeClass('selected'); 
            $('.selected1').removeClass('selected1');
            $('.preselected').addClass("selected");
            $('.preselected1').addClass("selected1");

            // Delete current plots
            $(".plot_data").remove();

            // Add new plots  thisProject
            // Science
            var $list = $('<div />');
            $list.addClass('plot_data'); 
            $(science_plots ).each(function(i, myvar) { 
            var png_src = ('static/' + thisProject.toLowerCase() + '/science/' + myvar + '.png');
            $list.append( $('<img class="img-responsive center-block" />').attr('src', png_src ) );
            });
            $('#science').append( $list );

            // Flight
            var $list = $('<div />');
            $list.addClass('plot_data'); 
            $(flight_plots ).each(function(i, myvar) { 
            var png_src = ('static/' + thisProject.toLowerCase() + '/flight/' + myvar + '.png');
            $list.append( $('<img class="img-responsive center-block" />').attr('src', png_src ) );
            });
            $('#flight').append( $list );

            // Surface
            var $list = $('<div />');
            $list.addClass('plot_data'); 
            $(surface_plots ).each(function(i, myvar) { 
            var png_src = ('static/' + thisProject.toLowerCase() + '/surface/' + myvar + '.png');
            $list.append( $('<img class="img-responsive center-block" />').attr('src', png_src ) );
            });
            $('#surface').append( $list );
         }
      });
   });
      </script>
   </body>
</html>